<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Prenotazioni B&B</title>
    <!-- Carica Tailwind CSS per uno stile moderno e reattivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .modal {
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .modal.hidden {
            opacity: 0;
            visibility: hidden;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
        .day-cell {
            padding-top: 100%; /* Rende le celle quadrate */
            position: relative;
            background-color: #f9fafb;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.1s ease, background-color 0.1s ease;
        }
        .day-cell:hover {
            transform: scale(1.05);
            background-color: #e5e7eb;
        }
        .day-cell-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px;
        }
        .day-number {
            font-weight: bold;
        }
        .booking-count {
            font-size: 0.75rem;
            color: #6b7280;
        }
        .footer-details {
            display: none;
            flex-direction: column;
            gap: 8px;
            padding: 16px;
            background-color: #fff;
            border-top: 1px solid #e5e7eb;
        }
        .footer-details.active {
            display: flex;
        }
        .selected-date-cell {
            background-color: #1c64f2;
            color: white;
            transform: scale(1.05);
        }
        .selected-date-cell .booking-count {
            color: white;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <div class="container mx-auto p-4 md:p-8">

        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-extrabold text-gray-800">Gestione Prenotazioni B&B</h1>
            <p class="text-sm md:text-base text-gray-500 mt-2">Strumento per la gestione del B&B. Aggiungi, visualizza e gestisci le prenotazioni dei tuoi ospiti.</p>
        </header>

        <!-- Main Content Wrapper -->
        <div id="app-container" class="bg-white rounded-lg shadow-lg p-6 md:p-8">

            <!-- Authentication Status -->
            <div id="auth-status" class="text-sm text-gray-500 mb-4 text-center">
                Autenticazione in corso...
            </div>
            
            <!-- App Views -->
            <div id="booking-calendar-view" class="view">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="current-month-year" class="text-xl md:text-2xl font-semibold text-gray-700"></h2>
                    <div class="flex space-x-2">
                        <button id="prev-month-btn" class="bg-gray-200 text-gray-700 p-2 rounded-lg hover:bg-gray-300 transition-colors duration-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <button id="next-month-btn" class="bg-gray-200 text-gray-700 p-2 rounded-lg hover:bg-gray-300 transition-colors duration-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- Calendar Weekdays Header -->
                <div class="calendar-grid text-center font-semibold text-gray-600 mb-2">
                    <div class="p-2">Lun</div>
                    <div class="p-2">Mar</div>
                    <div class="p-2">Mer</div>
                    <div class="p-2">Gio</div>
                    <div class="p-2">Ven</div>
                    <div class="p-2">Sab</div>
                    <div class="p-2">Dom</div>
                </div>

                <!-- Calendar Grid -->
                <div id="calendar-grid" class="calendar-grid">
                    <!-- Le celle del calendario verranno generate qui dal JS -->
                </div>

                <!-- Booking Details Section -->
                <div id="booking-details-footer" class="footer-details mt-4">
                    <h3 id="details-header" class="text-lg font-semibold text-gray-800">Dettagli Prenotazioni per il <span id="selected-date-display"></span></h3>
                    <div id="details-content" class="flex flex-col gap-2">
                        <!-- I dettagli delle prenotazioni verranno inseriti qui -->
                    </div>
                </div>

                <button id="showManagerBtn" class="mt-4 w-full bg-blue-500 text-white p-3 rounded-lg hover:bg-blue-600 transition-colors duration-200 shadow-md">Gestione Prenotazioni</button>
            </div>

            <div id="booking-manager-view" class="view hidden">
                <h2 class="text-2xl font-semibold mb-4 text-gray-700">Aggiungi Nuova Prenotazione</h2>
                <form id="booking-form" class="space-y-4">
                    <div>
                        <label for="client-name" class="block text-sm font-medium text-gray-700">Nome Cliente</label>
                        <input type="text" id="client-name" name="clientName" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2">
                    </div>
                    <div>
                        <label for="check-in" class="block text-sm font-medium text-gray-700">Check-in</label>
                        <input type="date" id="check-in" name="checkIn" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2">
                    </div>
                    <div>
                        <label for="check-out" class="block text-sm font-medium text-gray-700">Check-out</label>
                        <input type="date" id="check-out" name="checkOut" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2">
                    </div>
                    <div>
                        <label for="guests" class="block text-sm font-medium text-gray-700">Numero Ospiti</label>
                        <input type="number" id="guests" name="guests" required min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2">
                    </div>
                    <div>
                        <label for="price" class="block text-sm font-medium text-gray-700">Prezzo (€)</label>
                        <input type="number" id="price" name="price" required min="0" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2">
                    </div>
                    <div>
                        <label for="notes" class="block text-sm font-medium text-gray-700">Note</label>
                        <textarea id="notes" name="notes" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2"></textarea>
                    </div>
                    <button type="submit" class="w-full bg-green-500 text-white p-3 rounded-lg hover:bg-green-600 transition-colors duration-200 shadow-md">Aggiungi Prenotazione</button>
                </form>
                
                <h3 class="text-xl font-semibold mt-8 mb-4 text-gray-700">Lista Prenotazioni</h3>
                <input type="text" id="client-search" placeholder="Cerca per nome cliente..." class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 mb-4">
                <div id="booking-list-container" class="space-y-4">
                    <!-- Le prenotazioni verranno inserite qui -->
                </div>
                
                <button id="showCalendarBtn" class="mt-4 w-full bg-blue-500 text-white p-3 rounded-lg hover:bg-blue-600 transition-colors duration-200 shadow-md">Torna al Calendario</button>
            </div>
            
            <div id="data-summary-view" class="view hidden">
                <h2 class="text-2xl font-semibold mb-4 text-gray-700">Riepilogo Dati</h2>
                <div class="mb-4">
                    <label for="summary-filter-select" class="block text-sm font-medium text-gray-700">Filtra per:</label>
                    <select id="summary-filter-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                        <option value="month">Mese</option>
                        <option value="year">Anno</option>
                        <option value="all">Tutto</option>
                    </select>
                </div>
                
                <div id="filter-inputs" class="mb-4">
                    <!-- Inputs dinamici verranno inseriti qui -->
                </div>

                <div id="summary-results" class="bg-gray-50 rounded-lg p-4 shadow-inner">
                    <p class="text-lg font-medium text-gray-800">Guadagno totale: <span id="total-revenue" class="font-bold text-green-600">€0.00</span></p>
                    <p class="text-lg font-medium text-gray-800">Numero totale di prenotazioni: <span id="total-bookings" class="font-bold text-blue-600">0</span></p>
                    <p class="text-lg font-medium text-gray-800">Numero totale di ospiti: <span id="total-guests" class="font-bold text-purple-600">0</span></p>
                </div>
                
                <button id="showCalendarBtn2" class="mt-4 w-full bg-blue-500 text-white p-3 rounded-lg hover:bg-blue-600 transition-colors duration-200 shadow-md">Torna al Calendario</button>
            </div>

        </div>

        <!-- The Modal -->
        <div id="modal" class="modal fixed inset-0 flex items-center justify-center p-4 bg-gray-900 bg-opacity-50 hidden z-50">
            <div class="bg-white rounded-lg shadow-xl p-6 md:p-8 w-full max-w-sm">
                <h3 id="modal-title" class="text-xl font-semibold mb-4 text-gray-800"></h3>
                <p id="modal-message" class="text-gray-600 mb-4"></p>
                <button id="modal-close-btn" class="w-full bg-blue-500 text-white p-3 rounded-lg hover:bg-blue-600 transition-colors duration-200">OK</button>
            </div>
        </div>

    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, setDoc, deleteDoc, onSnapshot, query, where, orderBy, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase configuration and initialization
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const __initial_auth_token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        setLogLevel('debug');

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let userId = null;
        let bookings = [];
        let selectedDate = null;

        // UI elements
        const currentMonthYearEl = document.getElementById('current-month-year');
        const calendarGridEl = document.getElementById('calendar-grid');
        const prevMonthBtn = document.getElementById('prev-month-btn');
        const nextMonthBtn = document.getElementById('next-month-btn');
        const showManagerBtn = document.getElementById('showManagerBtn');
        const showCalendarBtn = document.getElementById('showCalendarBtn');
        const showCalendarBtn2 = document.getElementById('showCalendarBtn2');
        const showSummaryBtn = document.getElementById('showSummaryBtn');
        const bookingForm = document.getElementById('booking-form');
        const bookingListContainer = document.getElementById('booking-list-container');
        const clientSearchInput = document.getElementById('client-search');
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const summaryFilterSelect = document.getElementById('summary-filter-select');
        const filterInputsContainer = document.getElementById('filter-inputs');
        const totalRevenueEl = document.getElementById('total-revenue');
        const totalBookingsEl = document.getElementById('total-bookings');
        const totalGuestsEl = document.getElementById('total-guests');
        const bookingDetailsFooter = document.getElementById('booking-details-footer');
        const detailsHeader = document.getElementById('details-header');
        const detailsContent = document.getElementById('details-content');
        const selectedDateDisplay = document.getElementById('selected-date-display');
        const authStatusEl = document.getElementById('auth-status');


        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth();

        // Utility function to show modal
        const showModal = (title, message) => {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modal.classList.remove('hidden');
        };

        // Utility function to hide modal
        const hideModal = () => {
            modal.classList.add('hidden');
        };

        // Utility function to show a specific view
        const showView = (viewId) => {
            document.querySelectorAll('.view').forEach(view => {
                view.classList.add('hidden');
            });
            document.getElementById(viewId).classList.remove('hidden');
        };

        // Rendering the calendar
        const renderCalendar = () => {
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const numDays = lastDay.getDate();
            const startDay = firstDay.getDay(); // 0 for Sunday, 1 for Monday...
            const monthName = new Date(currentYear, currentMonth).toLocaleString('it-IT', { month: 'long', year: 'numeric' });
            currentMonthYearEl.textContent = monthName.charAt(0).toUpperCase() + monthName.slice(1);
            
            calendarGridEl.innerHTML = '';
            
            // Fill initial empty cells
            for (let i = 0; i < (startDay + 6) % 7; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.classList.add('day-cell', 'bg-gray-200');
                calendarGridEl.appendChild(emptyCell);
            }
            
            for (let i = 1; i <= numDays; i++) {
                const dayCell = document.createElement('div');
                dayCell.classList.add('day-cell', 'relative');
                dayCell.dataset.date = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                
                const bookingCount = bookings.filter(b => {
                    const checkInDate = new Date(b.checkIn);
                    const checkOutDate = new Date(b.checkOut);
                    const currentDate = new Date(currentYear, currentMonth, i);
                    return currentDate >= checkInDate && currentDate <= checkOutDate;
                }).length;
                
                dayCell.innerHTML = `
                    <div class="day-cell-content">
                        <span class="day-number text-gray-800">${i}</span>
                        ${bookingCount > 0 ? `<span class="booking-count text-blue-500">${bookingCount} prenotazion${bookingCount > 1 ? 'i' : 'e'}</span>` : ''}
                    </div>
                `;

                // Add event listener to show booking details
                dayCell.addEventListener('click', () => {
                    const selectedDateString = dayCell.dataset.date;
                    showBookingsForDate(selectedDateString);
                    document.querySelectorAll('.day-cell').forEach(cell => cell.classList.remove('selected-date-cell'));
                    dayCell.classList.add('selected-date-cell');
                });
                
                calendarGridEl.appendChild(dayCell);
            }
        };

        // Function to show bookings for a specific date
        const showBookingsForDate = (dateString) => {
            const date = new Date(dateString);
            selectedDate = date;
            const formattedDate = date.toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            selectedDateDisplay.textContent = formattedDate;

            const bookingsForDate = bookings.filter(b => {
                const checkInDate = new Date(b.checkIn);
                const checkOutDate = new Date(b.checkOut);
                return date >= checkInDate && date <= checkOutDate;
            });
            
            detailsContent.innerHTML = ''; // Clear previous details

            if (bookingsForDate.length > 0) {
                bookingDetailsFooter.classList.add('active');
                bookingsForDate.forEach(booking => {
                    const bookingEl = document.createElement('div');
                    bookingEl.classList.add('bg-gray-100', 'p-3', 'rounded-md', 'shadow-sm');
                    bookingEl.innerHTML = `
                        <p><span class="font-semibold">Cliente:</span> ${booking.clientName}</p>
                        <p><span class="font-semibold">Check-in:</span> ${booking.checkIn}</p>
                        <p><span class="font-semibold">Check-out:</span> ${booking.checkOut}</p>
                        <p><span class="font-semibold">Ospiti:</span> ${booking.guests}</p>
                        <p><span class="font-semibold">Prezzo:</span> €${booking.price.toFixed(2)}</p>
                        ${booking.notes ? `<p><span class="font-semibold">Note:</span> ${booking.notes}</p>` : ''}
                    `;
                    detailsContent.appendChild(bookingEl);
                });
            } else {
                detailsContent.innerHTML = `<p class="text-gray-500">Nessuna prenotazione per questa data.</p>`;
                bookingDetailsFooter.classList.add('active');
            }
        };

        // Render booking list with search and delete functionality
        const renderBookingList = (filteredBookings = bookings) => {
            bookingListContainer.innerHTML = '';
            if (filteredBookings.length === 0) {
                bookingListContainer.innerHTML = `<p class="text-gray-500 text-center">Nessuna prenotazione trovata.</p>`;
                return;
            }

            filteredBookings.forEach(booking => {
                const bookingEl = document.createElement('div');
                bookingEl.classList.add('bg-gray-50', 'p-4', 'rounded-lg', 'flex', 'flex-col', 'md:flex-row', 'justify-between', 'items-start', 'md:items-center', 'shadow-sm', 'border', 'border-gray-200', 'hover:bg-gray-100', 'transition-colors', 'duration-200');
                bookingEl.innerHTML = `
                    <div class="flex-grow">
                        <p class="font-bold text-gray-800 text-lg mb-1">${booking.clientName}</p>
                        <p class="text-sm text-gray-600">Check-in: <span class="font-medium">${booking.checkIn}</span></p>
                        <p class="text-sm text-gray-600">Check-out: <span class="font-medium">${booking.checkOut}</span></p>
                        <p class="text-sm text-gray-600">Ospiti: <span class="font-medium">${booking.guests}</span></p>
                        <p class="text-sm text-gray-600">Prezzo: <span class="font-medium text-green-600">€${booking.price.toFixed(2)}</span></p>
                        ${booking.notes ? `<p class="text-sm text-gray-600 mt-1">Note: <span class="italic">${booking.notes}</span></p>` : ''}
                    </div>
                    <div class="mt-4 md:mt-0 md:ml-4 flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-2">
                        <button class="delete-btn bg-red-500 text-white p-2 rounded-md hover:bg-red-600 transition-colors duration-200" data-id="${booking.id}">Elimina</button>
                    </div>
                `;
                bookingListContainer.appendChild(bookingEl);
            });

            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const docId = e.target.dataset.id;
                    if (confirm("Sei sicuro di voler eliminare questa prenotazione?")) {
                        try {
                            const collectionPath = `/artifacts/${appId}/users/${userId}/bookings`;
                            await deleteDoc(doc(db, collectionPath, docId));
                            showModal('Prenotazione Eliminata', 'La prenotazione è stata eliminata con successo.');
                        } catch (error) {
                            console.error("Errore durante l'eliminazione della prenotazione:", error);
                            showModal('Errore', "Non è stato possibile eliminare la prenotazione. Controlla la console per i dettagli.");
                        }
                    }
                });
            });
        };

        // Calculate and render data summary
        const calculateAndRenderSummary = (filter = 'all', value = '') => {
            let filteredBookings = [];
            if (filter === 'month' && value) {
                const [year, month] = value.split('-');
                filteredBookings = bookings.filter(b => {
                    const bookingDate = new Date(b.checkIn);
                    return bookingDate.getFullYear() == year && (bookingDate.getMonth() + 1) == month;
                });
            } else if (filter === 'year' && value) {
                filteredBookings = bookings.filter(b => {
                    const bookingDate = new Date(b.checkIn);
                    return bookingDate.getFullYear() == value;
                });
            } else {
                filteredBookings = bookings;
            }

            const totalRevenue = filteredBookings.reduce((sum, booking) => sum + parseFloat(booking.price), 0);
            const totalBookings = filteredBookings.length;
            const totalGuests = filteredBookings.reduce((sum, booking) => sum + parseInt(booking.guests), 0);

            totalRevenueEl.textContent = `€${totalRevenue.toFixed(2)}`;
            totalBookingsEl.textContent = totalBookings;
            totalGuestsEl.textContent = totalGuests;
        };

        const updateFilterInputs = (filter) => {
            filterInputsContainer.innerHTML = '';
            if (filter === 'month') {
                filterInputsContainer.innerHTML = `
                    <input type="month" id="summary-month-input" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                `;
                document.getElementById('summary-month-input').addEventListener('change', (e) => {
                    calculateAndRenderSummary(filter, e.target.value);
                });
            } else if (filter === 'year') {
                filterInputsContainer.innerHTML = `
                    <input type="number" id="summary-year-input" placeholder="Anno" min="2020" max="${new Date().getFullYear() + 5}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                `;
                document.getElementById('summary-year-input').addEventListener('input', (e) => {
                    calculateAndRenderSummary(filter, e.target.value);
                });
            }
        };

        // Event listeners
        prevMonthBtn.addEventListener('click', () => {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar();
            bookingDetailsFooter.classList.remove('active');
        });

        nextMonthBtn.addEventListener('click', () => {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderCalendar();
            bookingDetailsFooter.classList.remove('active');
        });

        showManagerBtn.addEventListener('click', () => { showView('booking-manager-view'); renderBookingList(); });
        showCalendarBtn.addEventListener('click', () => { showView('booking-calendar-view'); renderCalendar(); });
        showCalendarBtn2.addEventListener('click', () => { showView('booking-calendar-view'); renderCalendar(); });
        showSummaryBtn.addEventListener('click', () => { showView('data-summary-view'); updateFilterInputs(summaryFilterSelect.value); calculateAndRenderSummary(); });

        bookingForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!userId) {
                showModal('Errore', 'Autenticazione non riuscita. Riprova più tardi.');
                return;
            }

            const newBooking = {
                clientName: document.getElementById('client-name').value,
                checkIn: document.getElementById('check-in').value,
                checkOut: document.getElementById('check-out').value,
                guests: parseInt(document.getElementById('guests').value, 10),
                price: parseFloat(document.getElementById('price').value),
                notes: document.getElementById('notes').value,
                createdAt: new Date().toISOString()
            };

            try {
                const collectionPath = `/artifacts/${appId}/users/${userId}/bookings`;
                await addDoc(collection(db, collectionPath), newBooking);
                showModal('Prenotazione Aggiunta', 'La prenotazione è stata aggiunta con successo!');
                bookingForm.reset();
            } catch (error) {
                console.error("Errore durante l'aggiunta della prenotazione:", error);
                showModal('Errore', 'Non è stato possibile aggiungere la prenotazione. Controlla la console per i dettagli.');
            }
        });

        clientSearchInput.addEventListener('input', (e) => {
            const searchText = e.target.value.toLowerCase();
            const filtered = bookings.filter(b => b.clientName.toLowerCase().includes(searchText));
            renderBookingList(filtered);
        });

        modalCloseBtn.addEventListener('click', hideModal);

        summaryFilterSelect.addEventListener('change', (e) => {
            updateFilterInputs(e.target.value);
            calculateAndRenderSummary(e.target.value, '');
        });

        // Initialize Firebase Authentication listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                authStatusEl.textContent = `ID Utente: ${userId}`;
                const collectionPath = `/artifacts/${appId}/users/${userId}/bookings`;
                onSnapshot(collection(db, collectionPath), (snapshot) => {
                    bookings = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderCalendar();
                    renderBookingList();
                });
                showView('booking-calendar-view');
            } else {
                authStatusEl.textContent = 'Autenticazione anonima...';
                try {
                    if (__initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Errore durante l'autenticazione:", error);
                    authStatusEl.textContent = 'Autenticazione fallita.';
                }
            }
        });

    </script>
</body>
</html>
ccc
